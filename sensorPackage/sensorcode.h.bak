// =============================================================================
// AHT20 Temperature/Humidity Sensor
// =============================================================================

/**
 * @brief AHT20 sensor data
 */
typedef struct {
    float temperature_c;    // Temperature in Celsius
    float humidity_rh;      // Relative humidity in %
    bool valid;             // Data is valid
} aht20_data_t;

/**
 * @brief Initialize AHT20 sensor
 * @return ESP_OK on success
 */
esp_err_t aht20_init(void);

/**
 * @brief Read temperature and humidity from AHT20
 * @param data Output data structure
 * @return ESP_OK on success
 */
esp_err_t aht20_read(aht20_data_t *data);

// =============================================================================
// HX710B Pressure Sensor
// =============================================================================

/**
 * @brief HX710B sensor data
 */
typedef struct {
    float pressure_hpa;     // Pressure in hPa (hectopascals/millibars)
    int32_t raw_value;      // Raw 24-bit ADC value
    bool valid;             // Data is valid
} hx710b_data_t;

/**
 * @brief Initialize HX710B pressure sensor
 * @param sck_pin GPIO pin for serial clock
 * @param dout_pin GPIO pin for data output
 * @return ESP_OK on success
 */
esp_err_t hx710b_init(int sck_pin, int dout_pin);

/**
 * @brief Read pressure from HX710B
 * @param data Output data structure
 * @return ESP_OK on success
 */
esp_err_t hx710b_read(hx710b_data_t *data);

/**
 * @brief Calibrate HX710B (set zero offset)
 * @param known_pressure_hpa Known reference pressure in hPa
 * @return ESP_OK on success
 */
esp_err_t hx710b_calibrate(float known_pressure_hpa);

// =============================================================================
// AS3935 Lightning Detector
// =============================================================================

/**
 * @brief AS3935 interrupt reasons
 */
typedef enum {
    AS3935_INT_NONE = 0,
    AS3935_INT_NOISE = 1,
    AS3935_INT_DISTURBER = 4,
    AS3935_INT_LIGHTNING = 8
} as3935_interrupt_t;

/**
 * @brief AS3935 lightning strike data
 */
typedef struct {
    uint8_t distance_km;    // Estimated distance in km (0-63, or 0xFF if out of range)
    uint32_t energy;        // Lightning energy value
    as3935_interrupt_t type;// Type of interrupt
    bool valid;             // Data is valid
} as3935_data_t;

/**
 * @brief Initialize AS3935 lightning detector
 * @param irq_pin GPIO pin for interrupt (optional, -1 to disable)
 * @return ESP_OK on success
 */
esp_err_t as3935_init(int irq_pin);

/**
 * @brief Read lightning strike data from AS3935
 * @param data Output data structure
 * @return ESP_OK on success
 */
esp_err_t as3935_read(as3935_data_t *data);

/**
 * @brief Check if AS3935 has detected an event
 * @return Interrupt type (or AS3935_INT_NONE if no event)
 */
as3935_interrupt_t as3935_check_interrupt(void);

/**
 * @brief Configure AS3935 sensitivity
 * @param indoor true for indoor mode, false for outdoor
 * @return ESP_OK on success
 */
esp_err_t as3935_set_indoor_outdoor(bool indoor);

/**
 * @brief Clear accumulated lightning statistics
 */
void as3935_clear_statistics(void);

/**
 * @brief Get number of lightning strikes detected
 * @return Strike count
 */
uint32_t as3935_get_strike_count(void);

// =============================================================================
// Unified Sensor Interface
// =============================================================================

/**
 * @brief Complete weather sensor data
 */
typedef struct {
    // Temperature/Humidity (AHT20)
    float temperature_c;
    float humidity_rh;
    bool temp_humidity_valid;
    
    // Pressure (HX710B)
    float pressure_hpa;
    bool pressure_valid;
    
    // Lightning (AS3935)
    uint8_t lightning_distance_km;
    uint32_t lightning_energy;
    uint32_t lightning_strike_count;
    bool lightning_valid;
    
    // Overall validity
    bool any_valid;
} weather_data_t;

/**
 * @brief Initialize all sensors
 * @param hx710b_sck GPIO for HX710B clock
 * @param hx710b_dout GPIO for HX710B data
 * @param as3935_irq GPIO for AS3935 interrupt (-1 to disable)
 * @return ESP_OK if at least one sensor initialized
 */
esp_err_t sensors_init_all(int hx710b_sck, int hx710b_dout, int as3935_irq);

/**
 * @brief Read all sensors
 * @param data Output weather data
 * @return ESP_OK if at least one sensor read successfully
 */
esp_err_t sensors_read_all(weather_data_t *data);

/**
 * @brief Test all sensors and print diagnostics
 */
void sensors_run_diagnostics(void);

#endif // SENSORS_H